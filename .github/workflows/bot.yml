name: Lector de Vouchers Telegram

on:
  # Opci칩n 1: Ejecuci칩n Manual con Par치metros (Caso 3)
  workflow_dispatch:
    inputs:
      mes:
        description: 'Mes a analizar (1 = Enero, 12 = Diciembre)'
        required: false
        default: ''
      anio:
        description: 'A침o (Ej: 2025)'
        required: false
        default: ''

  # Opci칩n 2: Ejecuci칩n Autom치tica el d칤a 1 de cada mes (Caso 2)
  schedule:
    # Minuto 1, Hora 5 AM UTC (00:01 Hora Per칰/Colombia), D칤a 1
    - cron: '1 5 1 * *'

jobs:
  ejecutar-script:
    runs-on: ubuntu-latest

    steps:
      - name: 游닌 Descargar c칩digo
        uses: actions/checkout@v3

      - name: 游릭 Instalar Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: 游닍 Instalar librer칤as
        run: npm install

      - name: 游 Ejecutar Bot
        env:
          # Pasamos los inputs manuales si existen
          MANUAL_MONTH: ${{ github.event.inputs.mes }}
          MANUAL_YEAR: ${{ github.event.inputs.anio }}

          # Secretos
          TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
          TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
          TELEGRAM_SESSION: ${{ secrets.TELEGRAM_SESSION }}
          TARGET_CHAT_ID: ${{ secrets.TARGET_CHAT_ID }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
          GOOGLE_CREDENTIALS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}

        # CAMBIO CLAVE: Ejecutamos cloud_extractor.ts
        run: npx ts-node src/cloud_extractor.ts