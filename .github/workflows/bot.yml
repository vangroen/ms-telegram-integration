name: Lector de Vouchers Telegram

on:
  workflow_dispatch: # Para ejecutar manual
  schedule:
    - cron: '0 12 28 * *' # Ejecutar el 28 de cada mes

jobs:
  ejecutar-script:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Descargar c√≥digo
        uses: actions/checkout@v3

      - name: üü¢ Instalar Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: üì¶ Instalar librer√≠as
        run: npm install

      - name: üîê Generar archivo Credenciales Google
        # El JSON s√≠ lo creamos como archivo porque la librer√≠a de Google lo busca en disco
        run: echo "${{ secrets.GOOGLE_CREDENTIALS_JSON }}" > google-credentials.json

      - name: üöÄ Ejecutar Bot
        # AQU√ç EST√Å EL CAMBIO: Pasamos las variables directo a la memoria del proceso
        # Esto evita problemas de comillas o formato en un archivo .env
        env:
          TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
          TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
          TELEGRAM_SESSION: ${{ secrets.TELEGRAM_SESSION }}
          TARGET_CHAT_ID: ${{ secrets.TARGET_CHAT_ID }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
        run: npx ts-node src/index_clear.ts